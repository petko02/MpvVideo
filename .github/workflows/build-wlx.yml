name: Build WLX Plugin

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install --quiet --overwrite fpc pkg-config jpeg uchardet

    - name: Download mpv source (full) for headers
      run: |
        git clone --depth=1 --branch v0.34.0 https://github.com/mpv-player/mpv.git mpv-full
        mkdir -p mpv-headers
        cp -r mpv-full/libmpv mpv-headers/
        cp -r mpv-full/include/mpv mpv-headers/

    - name: Set environment paths for mpv
      run: |
        echo "CPATH=$PWD/mpv-headers:$PWD/mpv-headers/mpv:$CPATH" >> $GITHUB_ENV
        echo "DYLD_LIBRARY_PATH=$PWD/mpv-local/lib" >> $GITHUB_ENV

    - name: Patch BOOL typedef and ListGetDetectString
      run: |
        sed -i '' '1i\
#ifndef __OBJC__\
typedef int BOOL;\
#endif' mpvvideo.c
        sed -i '' 's/int DCPCALL ListGetDetectString/void DCPCALL ListGetDetectString/' mpvvideo.c

    - name: Compile mpvvideo.c
      run: |
        mkdir -p release/MpvVideo
        fpc -Mdelphi -Fu./mpv-headers -k"-framework Cocoa" -k"-L$DYLD_LIBRARY_PATH" mpvvideo.c -o./release/MpvVideo/mpvvideo.wlx

    - name: Copy plugin files
      run: |
        mkdir -p release/MpvVideo
        cp doublecmd-wlx-description.txt release/MpvVideo/
        cp mpv-local/lib/libmpv.dylib release/MpvVideo/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: MpvVideo-wlx
        path: release/MpvVideo
