name: Build MpvVideo WLX Plugin (macOS)

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout project
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          brew update
          brew install \
            coreutils \
            pkg-config \
            meson \
            ninja \
            jpeg \
            uchardet \
            lame \
            dav1d \
            ffmpeg \
            python@3.11

      - name: Download mpv 0.34.0 source
        run: |
          curl -L -o mpv.tar.gz https://github.com/mpv-player/mpv/archive/refs/tags/v0.34.0.tar.gz
          tar -xzf mpv.tar.gz
          mv mpv-0.34.0 mpv-source

      - name: Patch waf distutils
        run: |
          # PEP668 removed distutils from Python 3.12+
          sed -i '' 's/from distutils.version import StrictVersion/from packaging.version import Version as StrictVersion/' mpv-source/waftools/checks/generic.py

      - name: Build libmpv (shared)
        working-directory: ./mpv-source
        run: |
          python3 ./bootstrap.py
          ./waf configure --disable-cplayer --enable-libmpv-shared --prefix=$PWD/../mpv-local
          ./waf build
          ./waf install
          echo "PKG_CONFIG_PATH=$GITHUB_WORKSPACE/mpv-local/lib/pkgconfig" >> $GITHUB_ENV
          echo "DYLD_LIBRARY_PATH=$GITHUB_WORKSPACE/mpv-local/lib" >> $GITHUB_ENV

      - name: Copy mpv headers
        run: |
          mkdir -p include/mpv
          cp mpv-source/libmpv/client.h include/mpv/
          cp mpv-source/video/out/opengl_cb.h include/mpv/

      - name: Patch BOOL typedef and detect function
        run: |
          sed -i '' '1i\
#ifndef __OBJC__\
typedef int BOOL;\
#endif' mpvvideo.c
          sed -i '' 's/int DCPCALL ListGetDetectString/void DCPCALL ListGetDetectString/' mpvvideo.c

      - name: Compile mpvvideo.c
        run: |
          clang -Wall -O2 \
            -Iinclude -Iinclude/mpv \
            -I/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include \
            -framework Cocoa \
            -framework OpenGL \
            -shared -fPIC \
            -o release/MpvVideo/mpvvideo.wlx \
            mpvvideo.c \
            -Lmpv-local/lib -lmpv

      - name: Copy libmpv.dylib
        run: |
          cp mpv-local/lib/libmpv.* release/MpvVideo/

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: MpvVideo-Plugin
          path: release/MpvVideo/
