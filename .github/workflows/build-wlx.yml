name: Build WLX Plugin (MpvVideo)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-13

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v3

      - name: üõ†Ô∏è Install Dependencies
        run: |
          brew install fpc coreutils unzip curl

      - name: üß± Compile Cocoa Wrapper (libMpvPlayerView.dylib)
        run: |
          clang++ -dynamiclib -fobjc-arc -framework Cocoa \
            -o libMpvPlayerView.dylib MpvPlayerView.mm \
            -arch x86_64 -arch arm64

      - name: üß† Compile WLX Plugin (Free Pascal)
        run: |
          fpc -Px86_64 -XR/Library/Developer/CommandLineTools/usr/bin/ MpvVideo.pas -Fu. -oMpvVideo_x64.wlx
          fpc -Parm64 -XR/Library/Developer/CommandLineTools/usr/bin/ MpvVideo.pas -Fu. -oMpvVideo_arm64.wlx

      - name: üß¨ Merge into Universal WLX Plugin
        run: |
          lipo -create -output MpvVideo.wlx MpvVideo_x64.wlx MpvVideo_arm64.wlx
          file MpvVideo.wlx
          chmod +x MpvVideo.wlx

      - name: üì¶ Bundle plugin files
        run: |
          mkdir -p MpvVideo_Package
          cp MpvVideo.wlx MpvVideo_Package/
          cp libMpvPlayerView.dylib MpvVideo_Package/

          # Optional: Include your existing libmpv.dylib (must be universal)
          if [ -f libmpv.dylib ]; then
            cp libmpv.dylib MpvVideo_Package/
          fi

      - name: üóúÔ∏è Create ZIP archive
        run: |
          zip -r MpvVideo_macOS_Universal.zip MpvVideo_Package

      - name: üì§ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MpvVideo_WLX_Plugin
          path: MpvVideo_macOS_Universal.zip
